{
  "child": "cee68fafdba31010c6ea1fc768961951",
  "cloned": "2020-10-05 18:17:08",
  "last_validated": "2020-10-05 18:17:08",
  "parent": "85357f52cb30020000f8d856634c9c24",
  "payload": "<?xml version=\"1.0\" encoding=\"UTF-8\"?><sp_widget><category>standard</category><client_script><![CDATA[function spTicketConversation($scope, nowAttachmentHandler, $animate, $rootScope, cabrillo, $timeout, snRecordWatcher, spUtil, spAriaUtil, $http, $window, $sce, snAttachmentHandler, i18n, dynamicTranslation) {\n\t$scope.showLocationIcon = false;\n\t$scope.msg = \"\";\n\t$scope.isNative = cabrillo.isNative();\n\t$scope.errorMessages = [];\n\tvar existingEntries = {};\n\tvar c = this;\n\tvar skipNextRecordWatchUpdate = false;\n\t$scope.typing = [];\n\tif (!$scope.data.hasReadableJournalField && !$scope.data.isNewRecord)\n\t\tconsole.warn(\"No readable journal field (comments, work notes, etc.) available in the stream for this record\");\n\tif ($scope.page && $scope.page.g_form)\n\t\thideParentJournalFields();\n\n\tfunction hideParentJournalFields() {\n\t\tif (!$scope.data.stream)\n\t\t\treturn;\n\n\t\tvar fields = $scope.data.stream.journal_fields;\n\t\tvar g_form = $scope.page.g_form;\n\t\tfor (var f in fields)\n\t\t\tg_form.setDisplay(fields[f].name, false);\n\t}\n\tvar liveProfiles = {};\n\tliveProfiles[$scope.user.sys_id] = {\n\t\tuserID: $scope.user.sys_id,\n\t\tname: $scope.user.name,\n\t\tinitials: $window.NOW.user_initials\n\t};\n\tif ($window.NOW.user_avatar) {\n\t\tliveProfiles[$scope.user.sys_id].userImage = $window.NOW.user_avatar;\n\t}\n\n\t$scope.getLiveProfileByUserId = function (userId){\n\t\treturn liveProfiles[userId];\n\t}\n\n\tvar pending = {};\n\n\t//Little caching implementation to make sure we only get a given user's profile once.\n\t$scope.hasLiveProfile = function hasLiveProfile(userId){\n\t\tif (!userId)\n\t\t\treturn false;\n\n\t\tif (liveProfiles[userId])\n\t\t\treturn true;\n\t\t\n\t\tif (pending[userId])\n\t\t\treturn false;\n\t\t\n\t\tpending[userId] = $http.get('/api/now/live/profiles/sys_user.' + userId).then(function (response) {\n\t\t\tliveProfiles[userId] = {\n\t\t\t\tuserID: userId,\n\t\t\t\tname: response.data.result.name,\n\t\t\t\tinitials: buildInitials(response.data.result.name),\n\t\t\t\tavatar: response.data.result.avatar\n\t\t\t};\n\t\t});\n\t\treturn false;\n\t}\n\n\tfunction buildInitials(name) {\n\t\tif (!name)\n\t\t\treturn \"--\";\n\t\t\n\t\tvar initialMatchRegex = /^[A-ZÀ-Ÿ]|^[\\u3040-\\u309f]|^[\\u30a0-\\u30ff]|^[\\uff66-\\uff9f]|^[\\u4e00-\\u9faf]/;\n\t\t// Included Hiragana, Katakana, CJK Unified Ideographs and Halfwidth and Fullwidth Forms Blocks \n\t\t// Hiragana -> Japanese words, Katakana -> foreign words\n\t\t// CJK Unified Ideographs -> modern Chinese, Japanese, Korean and Vietnamese characters \n\t\t\n\t\tvar initials = name.split(\" \").map(function(word) {\n\t\t\treturn word.toUpperCase();\n\t\t}).filter(function(word) {\n\t\t\treturn word.match(initialMatchRegex);\n\t\t}).map(function(word) {\n\t\t\treturn word.substring(0,1);\n\t\t}).join(\"\");\n\n\t\treturn (initials.length > 3) ? initials.substr(0, 3) : initials;\n\t}\n\n\n\tfunction setupAttachmentHandler(){\n\t\t$scope.attachmentHandler = new nowAttachmentHandler(attachSuccess, appendError);\n\n\t\tfunction attachSuccess() {\n\t\t\t$rootScope.$broadcast(\"sp.attachments.update\", $scope.data.sys_id);\n\t\t\tspAriaUtil.sendLiveMessage($scope.data.attachAddedMsg);\n\t\t}\n\n\t\tfunction appendError(error) {\n\t\t\tspUtil.addErrorMessage(error.msg + error.fileName);\n\t\t\t$scope.errorMessages.push(error);\n\t\t\tspAriaUtil.sendLiveMessage($scope.data.attachFailMsg);\n\t\t}\n\n\t\t$timeout(function() {\n\t\t\t$scope.attachmentHandler.setParams($scope.data.table, $scope.data.sys_id, 1024 * 1024 * $scope.data.maxAttachmentSize);\n\t\t})\n\t}\n\tsetupAttachmentHandler();\n\n\tvar recordWatcherTimer;\n\t$scope.$on('record.updated', function(name, data) {\n\t\t// Use record watcher update if:\n\t\t//\tThis record was updated AND This widget didn't trigger the update.\n\t\tif (data.table_name == $scope.data.table && data.sys_id == $scope.data.sys_id){\n\t\t\t$timeout.cancel(recordWatcherTimer);\n\t\t\trecordWatcherTimer = $timeout(function(){\n\t\t\t\tif (skipNextRecordWatchUpdate)\n\t\t\t\t\tskipNextRecordWatchUpdate = false;\n\t\t\t\telse\n\t\t\t\t\tspUtil.update($scope).then(function(r){\n\t\t\t\t\t\t$scope.data.stream = r.stream;\n\t\t\t\t\t});\n\t\t\t}, 250);\n\t\t}\n\t});\n\n\t$scope.$on('sp.show_location_icon', function(evt) {\n\t\t$scope.data.showLocationIcon = true;\n\t});\n\t\n\t$scope.$on('attachment.updated', function(evt,options) {\n\t\tif ($scope.data.sys_id != -1 && options.sys_id == $scope.data.sys_id)\n\t\t\tupdateAttachmentState($scope.data.table, $scope.data.sys_id);\n\t});\n\t\n\n\tfunction updateAttachmentState(table, sys_id) {\n\t\t\tc.server.update().then(function (data) {\n\t\t\t\t\tif (!data.stream || !data.stream.entries)\n\t\t\t\t\t\treturn;\n\t\t\t\t\tvar newEntries = data.stream.entries;\n\t\t\t\t\tvar currEntries = $scope.data.mergedEntries;\n\t\t\t\t\tvar oldSize = currEntries ? currEntries.length : 0;\n\t\t\t\t\tvar newSize = newEntries.length;\n\t\t\t\t\tfor (var i = 0; i < oldSize; i++) {\n\t\t\t\t\t\t\tif (!currEntries[i].attachment)\n\t\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\tfor (var j = 0; j < newSize; j++) {\n\t\t\t\t\t\t\t\t\tif (currEntries[i].sys_id == newEntries[j].sys_id && newEntries[j].attachment) {\n\t\t\t\t\t\t\t\t\t\t\tcurrEntries[i].attachment.state = newEntries[j].attachment.state;\n\t\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t});\n\t}\n\t\n\t$scope.scanAttachment = function(attachment){\n\t\tsnAttachmentHandler.scanAttachment(attachment);\n\t}\n\t\n\t$rootScope.$on('sp.sessions', function(evt, sessions) {\n\t\t$scope.typing = [];\n\t\tObject.keys(sessions).forEach(function (session) {\n\t\t\tvar journalFields = scope.data.stream.journal_fields;\n\t\t\tvar canUserReadJournalField = false;\n\t\t\tsession = sessions[session];\n\t\t\t\n\t\t\tfor (var j = 0; j < journalFields.length; j++) {\n\t\t\t\tif (journalFields[j].name === session.field_type) {\n\t\t\t\t\tcanUserReadJournalField = journalFields[j].can_read;\n\t\t\t\t\tbreak;\n\t\t\t\t}\t\t\t\t\t\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\tif (session.status === 'typing' && canUserReadJournalField)\n\t\t\t\t$scope.typing.push(session);\n\t\t\telse\n\t\t\t\treturn;\n\t\n\t\t})\n\t})\n\n\t$scope.$on('sp.conversation_title.changed', function(evt, text) {\n\t\t$scope.data.ticketTitle = text;\n\t})\n\n\t$scope.$watch(\"data.canWrite\", function() {\n\t\t$rootScope.$broadcast(\"sp.record.can_write\", $scope.data.canWrite);\n\t});\n\n\tvar streamUpdateTimer;\n\t$scope.$watch(\"data.stream\", function() {\n\t\t$timeout.cancel(streamUpdateTimer);\n\t\tstreamUpdateTimer = $timeout(function() {\n\t\t\tmergeStreamEntries();\n\t\t}, 50);\n\t});\n\n\tfunction mergeStreamEntries() {\n\t\t$scope.placeholder = $scope.data.placeholderNoEntries;\n\t\tif (!$scope.data.stream || !$scope.data.stream.entries)\n\t\t\treturn;\n\n\t\t$scope.placeholder = $scope.data.placeholder;\n\t\tvar entries = $scope.data.stream.entries;\n\t\tfor (var i = 0; i < entries.length; i++) {\n\t\t    if (entries[i].attachment)\n\t\t        entries[i].attachment = $scope.attachmentHandler.canViewImage([entries[i].attachment])[0];\n\t\t}\n\t\tif (!$scope.data.mergedEntries) {\n\t\t\t$scope.data.mergedEntries = $scope.data.stream.entries.slice();\n\t\t\tfor (var i = 0; i < entries.length; i++) {\n\t\t\t\texistingEntries[entries[i].sys_id] = true;\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\n\t\tvar mergedEntries = $scope.data.mergedEntries;\n\t\tfor (var i = entries.length-1; i >= 0; i--) {\n\t\t\tvar curEntry = entries[i];\n\t\t\tif (isNewEntry(mergedEntries, curEntry)){\n\t\t\t\tmergedEntries.unshift(curEntry);\n\t\t\t\texistingEntries[curEntry.sys_id] = true;\n\t\t\t}\n\t\t}\n\t}\n\n\tfunction isNewEntry(mergedEntries, item) {\n\t\tfor (var i=0; i < mergedEntries.length; i++) {\n\t\t\tif (mergedEntries[i].sys_id === item.sys_id) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\t$scope.getPlaceholder = function() {\n\t\tif ($scope.data.use_dynamic_placeholder && $scope.data.useSecondaryJournalField)\n\t\t\treturn $scope.data.secondaryJournalField.label;\n\t\treturn $scope.placeholder;\n\t};\n\n\tvar colorCache;\n\t$scope.getFieldColor = function(fieldName) {\n\t\tvar defaultColor = \"transparent\";\n\t\tif (colorCache) {\n\t\t\tif (fieldName in colorCache)\n\t\t\t\treturn colorCache[fieldName];\n\t\t\telse\n\t\t\t\treturn defaultColor;\n\t\t}\n\n\t\tcolorCache = {};\n\t\tvar jf = $scope.data.stream.journal_fields;\n\t\tfor (var i=0; i<jf.length;i++) {\n\t\t\tcolorCache[jf[i].name] = jf[i].color || defaultColor;\n\t\t}\n\t\treturn $scope.getFieldColor(fieldName);\n\t}\n\n\t$scope.checkInLocation = function() {\n\t\t$rootScope.$broadcast(\"check_in_location\");\n\t\t$rootScope.$broadcast(\"location.sharing.start\");\n\t}\n\n\t$scope.$on(\"location.sharing.end\", function() {\n\t\t$timeout(function() {$scope.msg = \"\"}, 500);\n\t})\n\n\t$scope.$on(\"location.sharing.start\", function() {\n\t\t$scope.msg = $scope.data.sharingLocMsg;\n\t})\n\n\t$scope.scanBarcode = function() {\n\t\t$rootScope.$broadcast(\"scan_barcode\");\n\t}\n\n\t$scope.$on(\"attachment.upload.start\", function() {\n\t\t$scope.data.isPosting = true;\n\t\t$scope.msg = $scope.data.uploadingAttachmentMsg;\n\t})\n\n\t$scope.$on(\"attachment.upload.stop\", function() {\n\t\t$scope.data.isPosting = false;\n\t\t$scope.msg = \"\";\n\t\t//update the stream so we get the new attachment\n\t\tspUtil.update($scope).then(function(r) {\n\t\t\t$scope.data.stream = r.stream;\n\t\t});\n\t});\n\n\t$scope.trustAsHtml = function(text) {\n\t\treturn $sce.trustAsHtml(text);\n\t}\n\t\n\t$scope.data.isPosting = false;\n\n\t$scope.postEntry = function(input) {\n\t\tpost(input);\n\t};\n\n\tfunction post(input) {\n\t\tif ($scope.data.isPosting)\n\t\t\treturn;\n\n\t\tif (!input)\n\t\t\treturn;\n\n\t\tinput = input.trim();\n\t\t$scope.data.journalEntry = input;\n\n\t\tif ($scope.data.useSecondaryJournalField)\n\t\t\t$scope.data.journalEntryField = $scope.data.secondaryJournalField.name;\n\t\telse\n\t\t\t$scope.data.journalEntryField = $scope.data.primaryJournalField.name;\n\t\t$scope.data.isPosting = true;\n\t\tspUtil.update($scope).then(function(){\n\t\t\t$scope.data.isPosting = false;\n\t\t\treset();\n\t\t\tspAriaUtil.sendLiveMessage($scope.data.messagePostedMsg);\n\t\t\t$timeout(function() {\n\t\t\t\t$scope.setFocus(); // sets focus back on input, defined in \"link\"\n\t\t\t});\n\t\t});\n\t\tskipNextRecordWatchUpdate = true;\n\t\t$scope.setFocus(); // sets focus back on input, defined in \"link\"\n\t}\n\n\tvar reset = function(){\n\t\t$scope.userTyping(\"\");\n\t\t$scope.data.journalEntry = \"\";\n\t\t$scope.updateFormWithJournalFields();\n\t\t$scope.data.useSecondaryJournalField = false;\n\t\t$scope.data.journalEntryField = \"\";\n\t}\n\n\t$scope.keyPress = function(event) {\n\t\tif ($scope.data.isPosting) {\n\t\t\tif (event.keyCode === 13 && !event.shiftKey)\n\t\t\t\tevent.preventDefault();\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tif ($scope.data.enterKeyAddsNewLine)\n\t\t\treturn; // must click Send button to submit\n\t\t\n\t\tif (event.keyCode === 13 && !event.shiftKey) {\n\t\t\tevent.preventDefault();\n\t\t\t$timeout(function() {\n\t\t\t\tif ($scope.data.journalEntry)\n\t\t\t\t\t$scope.postEntry($scope.data.journalEntry);\n\t\t\t}, 250);\n\t\t}\n\t}\n\n\t$scope.userTyping = function(input) {\n\t\tvar status = \"viewing\";\n\t\tif (input.length)\n\t\t\tstatus = \"typing\";\n\n\t\tvar field = $scope.data.useSecondaryJournalField ? $scope.data.secondaryJournalField.name : $scope.data.primaryJournalField.name;\n\t\t$scope.$emit(\"record.typing\", {status: status, value: input, table: $scope.data.table, sys_id: $scope.data.sys_id, field_type: field});\n\t\t$scope.updateFormWithJournalFields();\n\t}\n\t$scope.updateFormWithJournalFields = function () {\n\t\tvar fieldName, fieldToClear = \"\";\n\t\tif ($scope.data.useSecondaryJournalField) {\n\t\t\tfieldName = $scope.data.secondaryJournalField.name;\n\t\t\tfieldToClear = $scope.data.primaryJournalField.name;\n\t\t} else {\n\t\t\tfieldName = $scope.data.primaryJournalField.name;\n\t\t\tfieldToClear = \"\";\n\t\t}\n\t\t$scope.$emit(\"activity_stream_is_changed\", {\"fieldName\": fieldName, \"fieldToClear\": fieldToClear, \"input\": $scope.data.journalEntry});\n\t}\n\n\t$scope.toggleTranslation = function(e) {\n\t    e.showDetails = !e.showDetails;\n\t\tvar translationObject = c.data.translation;\n\t    e.toggleMsg = e.showDetails ? translationObject.hideMsg : translationObject.showMsg;\n\t};\n\n\t$scope.getTranslatedText = function(translations) {\n\t    if (!(Array.isArray(translations)))\n\t        return;\n\t    var translatedText;\n\t    var translationsLength = translations.length;\n\t    for (var index = 0; index < translationsLength; index++) {\n\t        if (translations[index].targetLanguage === g_lang) {\n\t            translatedText = translations[index].translatedText;\n\t            break;\n\t        }\n\t    }\n\t    return translatedText;\n\t};\n\n\t$scope.getAdditionalParameters = function(e, isRetry) {\n\t    return {\n\t        'event': {\n\t            'eventName': 'Activity Stream - Portal',\n\t            'fieldType': e.element,\n\t            'retry': isRetry\n\t        },\n\t        'additionalParameters': [{\n\t            'parameterName': 'textType',\n\t            'parameterValue': 'html'\n\t        }, {\n\t            'parameterName': 'escapeHtml',\n\t            'parameterValue': e.contains_code\n\t        }]\n\t    };\n\t}\n\n\t$scope.showTranslationInProgress = function(e) {\n\t    e.showTranslation = true;\n\t    e.isTranslationInProgress = true;\n\t    e.isTranslationSuccess = false;\n\t    e.isTranslationError = false;\n\t}\n\n\t$scope.showTranslationSuccess = function(e, translatedText, credits) {\n\t    e.translatedText = translatedText;\n\t    e.credits = credits;\n\t    e.toggleMsg = c.data.translation.hideMsg;\n\t    e.isTranslationInProgress = false;\n\t    e.isTranslationSuccess = true;\n\t    e.isTranslationError = false;\n\t    e.showDetails = true;\n\t}\n\n\t$scope.showTranslationError = function(e, errorMessage, tryAgain) {\n\t    e.isTranslationInProgress = false;\n\t    e.isTranslationSuccess = false;\n\t    e.isTranslationError = true;\n\t    e.translatedText = errorMessage;\n\t    e.tryAgain = tryAgain;\n\t}\n\n\t$scope.translateText = function(e, isRetry) {\n\t    $scope.showTranslationInProgress(e);\n\t    var translationObject = c.data.translation;\n\t    dynamicTranslation.getTranslation(e.value, $scope.getAdditionalParameters(e, isRetry)).then(\n\t        function(successResponse) {\n\t            if (successResponse.detectedLanguage.code === g_lang) {\n\t                $scope.showTranslationError(e, translationObject.sameLanguageErrorMsg, false);\n\t                return;\n\t            }\n\t            var translatedText = $scope.getTranslatedText(successResponse.translations);\n\t            if (translatedText) {\n\t                var credits = i18n.format(translationObject.creditsMsg, successResponse.translator);\n\t                $scope.showTranslationSuccess(e, translatedText, credits);\n\t            } else {\n\t                translatedText = translationObject.genericErrorMsg;\n\t                $scope.showTranslationError(e, translatedText, true);\n\t            }\n\t        },\n\t        function(errorResponse) {\n\t            var errorCode = errorResponse.code;\n\t            var errorMessage;\n\t            var showRetry = false;\n\t            switch (errorCode) {\n\t                case '40052':\n\t                    errorMessage = translationObject.maxLengthErrorMsg;\n\t                    break;\n\t                case '40055':\n\t                    errorMessage = translationObject.credentialsErrorMsg;\n\t                    break;\n\t                case '40053':\n\t                case '40054':\n\t                case '40056':\n\t                    errorMessage = translationObject.langNotSupportedErrorMsg;\n\t                    break;\n\t                default:\n\t                    errorMessage = translationObject.genericErrorMsg;\n\t                    showRetry = true;\n\t            }\n\t            $scope.showTranslationError(e, errorMessage, showRetry);\n\t        }\n\t    );\n\t}\n}]]></client_script><controller_as>c</controller_as><css>.panel-title {\n  display: inline;\n}\n\n.panel-title-container {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.panel-title-icons {\n\n  ul {\n    display: flex;\n    align-items: center;\n    padding: 0;\n    margin: 0;\n  }\n  li {\n    padding: 0;\n    margin: 0;\n\n    .panel-button {\n      display: flex;\n      align-items: center;\n      margin: 0 0 0 15px;\n      line-height: initial;\n\n      &amp;:hover, &amp;:focus {\n        text-decoration: none;\n      }\n    }\n  }\n}\n\n\n.timeline-heading test {\n  float:right;\n}\n\n.timeline-body &gt; p {\n  white-space: pre-wrap;\n  overflow-x: hidden;\n}\n\n.timeline-body ul &gt; li {\n  float: none;\n}\n\n.no-resize {\n  resize: none;\n}\n\n.journal-field-indicator {\n  width: 5px;\n  position: absolute;\n  left: 5px;\n  top: 5px;\n  bottom: 5px;\n  z-index: 3;\n}\n\n.panel-heading {\n  word-wrap: break-word;\n}\n\n.avatar-container {\n  cursor: default;\n}\n\nul {\n  list-style: none;\n}\n\n.overflow-hidden {\n  overflow: hidden;\n}\n\n\n.timeline-badge-wrap {\n  margin: auto;\n  max-width: 115px;\n}\n\n.timeline-badge.success {\n  background-color: $success;\n}\n\n.timeline-badge {\n  position: relative;\n  left:25%;\n  width:50%;\n  padding-bottom:50%;\n  border-radius:50%;\n}\n\n.timeline-badge span{\n  position:absolute;\n  top:50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  font-size:13px;\n  color: #fff;\n}\n\n.timeline::before {\n  content: none;\n}\n\n.timeline-before {\n    content: '';\n    position: absolute;\n    top: 0;\n    bottom: 20px;\n    left: 0;\n    right: 50%;\n    border-right: 2px #dee5e7 solid;  \n}\n\n.journal-type {\n \tdisplay: inline-flex;\n  display: -ms-inline-flexbox;\n  flex-wrap: wrap;\n  -webkit-justify-content: flex-end;\n}\n\n.fa-circle {\n  font-size: 4px;\n  padding: 7px;\n}\n\n@media (max-width: 768px) {\n  .timeline-badge-wrap {\n    margin: 0;\n  }\n  .timeline-badge {\n    left: 10%;\n  }\n}\n\n.translation-font {\n  font-size: 12px;\n}\n\n.translate-link {\n  cursor: pointer;\n  @extend .translation-font;\n}\n\n.translation-credits {\n  font-style: italic;\n}\n\n.translation-message {\n  padding-top: 10px;\n  font-size: 14px;\n  white-space: pre-wrap;\n}\n\n.toggle-link-show {\n  display: none;\n}\n\n.translation-credits {\n  font-style: italic;\n}\n\n.translation-icon {\n  width: 12px;\n  height: 12px;\n  padding-right: 4px;\n  @extend .translation-font;\n}\n\n.translation-container {\n  border: 1px solid $well-border;\n  border-radius: 3px;\n  background-color: $well-bg;\n  padding: 10px;\n  color: $text-color;\n  margin-top: 10px;\n  @extend .translation-font;\n}\n\n.translation-delimiter {\n  padding: 7px;\n  @extend .translation-font;\n}\n\n.translate-wrap {\n  white-space: nowrap;\n}\n\t\t</css><data_table>sp_instance</data_table><demo_data>{\"options\": {\n\t\"sys_id\": -1,\n\t\t\"table\": \"incident\"\n\t}\n}</demo_data><description/><docs/><field_list/><has_preview>false</has_preview><id>widget-ticket-conversation</id><internal>false</internal><link><![CDATA[function(scope, elm) {\n\t// Set the focus back on the input for IE11\n\tscope.setFocus = function() {\n\t\tvar input = $(elm[0]).find('textarea#post-input');\n\t\tif (input[0])\n\t\t\tinput[0].focus();\n\t}\n}]]></link><name>Ticket Conversations</name><option_schema>[{\"hint\":\"Placeholder text shows selected journal field\",\"name\":\"use_dynamic_placeholder\",\"section\":\"Behavior\",\"label\":\"Use dynamic placeholder\",\"type\":\"boolean\"},{\"hint\":\"Message to show when record has no readable journal field\",\"name\":\"no_readable_journal_field_message\",\"default_value\":\"\",\"section\":\"Presentation\",\"label\":\"No readable journal field message\",\"type\":\"string\"},{\"hint\":\"Enter key behavior is specified by system property (glide.service_portal.comment.enter_adds_newline) unless overridden here\",\"name\":\"enter_key_behavior\",\"section\":\"Behavior\",\"default_value\":\"System property\",\"label\":\"Enter key behavior\",\"type\":\"choice\",\"choices\":[{\"label\":\"System property\",\"value\":\"System property\"},{\"label\":\"Submit\",\"value\":\"Submit\"},{\"label\":\"New line\",\"value\":\"New line\"}]}]</option_schema><public>false</public><roles>snc_external,snc_internal</roles><script><![CDATA[(function() {\n\tdata.currentUserID = gs.getUserID();\n\tdata.maxAttachmentSize = parseInt(gs.getProperty(\"com.glide.attachment.max_size\", 1024));\n\tif (isNaN(data.maxAttachmentSize))\n\t\tdata.maxAttachmentSize = 24;\n\tdata.uploadingAttachmentMsg = gs.getMessage(\"Uploading attachment...\");\n\tdata.sharingLocMsg = gs.getMessage(\"Sharing location...\");\n\tdata.scanBarcodeMsg = gs.getMessage(\"Scan barcode\");\n\tdata.checkInLocMsg = gs.getMessage(\"Check in location\");\n\tdata.messagePostedMsg = gs.getMessage(\"Message has been sent\");\n\tdata.viewMsg = gs.getMessage(\"View\");\n\tdata.attachAddedMsg = gs.getMessage(\"Attachment added\");\n\tdata.attachFailMsg = gs.getMessage(\"Failed to add attachment\");\n\tdata.scanFailedMsg = gs.getMessage(\"File failed security scan\");\n\tdata.sys_id = (input && input.sys_id) || options.sys_id || $sp.getParameter(\"sys_id\");\n\tdata.table = (input && input.table) || options.table || $sp.getParameter(\"table\");\n\t// don't use options.title unless sys_id and table also come from options\n\tif (options && options.sys_id && options.table)\n\t\tdata.ticketTitle = options.title;\n\tdata.placeholder = options.placeholder || gs.getMessage(\"Type your message here...\");\n\tdata.placeholderNoEntries = options.placeholderNoEntries || gs.getMessage(\"Type your message here...\");\n\tdata.btnLabel = options.btnLabel || gs.getMessage(\"Send\");\n\tdata.includeExtended = options.includeExtended || false;\n\tdata.use_dynamic_placeholder = options.use_dynamic_placeholder;\n\tdata.hideAttachmentBtn = options.hideAttachmentBtn;\n\tdata.viewAttachmentMsg = gs.getMessage(\"View attachment\");\n\tdata.downloadAttachmentMsg = gs.getMessage(\"Download attachment\");\n\n\tvar translationLuaParameters = {\n\t\t'event': {\n\t\t\t'eventName': 'Activity Stream - Portal'\n\t\t\t}\n\t\t};\n\tvar isDynamicTranslationInstalled = GlidePluginManager.isActive(\"com.glide.dynamic_translation\");\n\tif (isDynamicTranslationInstalled) {\n\t\tvar isDynamicTranslationEnabled\t= sn_dt_api.DynamicTranslation.isEnabled(translationLuaParameters);\n\t\tdata.isTranslationEnabled = isDynamicTranslationEnabled && isDynamicTranslationEnabled.translation;\n\t\tif(data.isTranslationEnabled)\n\t\t\tinitDynamicTranslation();\n\t}\n\n\tfunction initDynamicTranslation() {\n\t    var translation = {};\n\t    translation.translateLinkMsg = gs.getMessage(\"Translate\");\n\t    translation.sameLanguageErrorMsg = gs.getMessage(\"This content is written in your preferred language. No need to translate.\");\n\t    translation.genericErrorMsg = gs.getMessage(\"Unable to translate.\");\n\t    translation.credentialsErrorMsg = gs.getMessage(\"Credentials are missing or invalid. Contact your administrator.\");\n\t    translation.maxLengthErrorMsg = gs.getMessage(\"Text has exceeded the maximum length.\");\n\t    translation.langNotSupportedErrorMsg = gs.getMessage(\"Text cannot be translated to your preferred language.\");\n\t    translation.creditsMsg = gs.getMessage(\"Translated by {0}\");\n\t    translation.translationProgressMsg = gs.getMessage(\"Translating...\");\n\t    translation.hideMsg = gs.getMessage(\"Hide\");\n\t    translation.showMsg = gs.getMessage(\"Show\");\n\t    translation.tryAgainMsg = gs.getMessage(\"Try Again\");\n\t    data.translation = translation;\n\t}\n\n\tdata.enterKeyAddsNewLine = false;\n\tif (options.enter_key_behavior == \"System property\")\n\t\tdata.enterKeyAddsNewLine = gs.getProperty(\"glide.service_portal.comment.enter_adds_newline\") == \"true\";\n\telse if (options.enter_key_behavior == \"New line\")\n\t\tdata.enterKeyAddsNewLine = true;\n\n\tvar gr = new GlideRecord(data.table);\n\tif (!gr.isValid())\n\t\treturn;\n\n\tgr.get(data.sys_id);\n\tdata.isNewRecord = data.sys_id == -1 || gr.isNewRecord();\n\tif ((!gr.isValidRecord() && data.sys_id != -1) || !gr.canRead())\n\t\treturn;\n\n\tdata.table = gr.getRecordClassName(); // use actual table for the record\n\toptions.no_readable_journal_field_message = options.no_readable_journal_field_message || gs.getMessage(\"No readable comment field\");\n\tdata.number = gr.getDisplayValue('number');\n\tdata.created_on = gr.getValue('sys_created_on');\n\n\tif (input) { // if we have input then we're saving\n\t\tif (input.journalEntry && input.journalEntryField){\n\t\t\tif (gr.canWrite(input.journalEntryField)){\n\t\t\t\tgr[input.journalEntryField].setDisplayValue(input.journalEntry);\n\t\t\t\tgr.update();\n\t\t\t\t$sp.logStat('Comments', data.table, data.sys_id, input.journalEntry);\n\t\t\t}\n\t\t}\n\t\tdata.ticketTitle = input.ticketTitle;\n\t\tdata.placeholder = input.placeholder;\n\t\tdata.btnLabel = input.btnLabel;\n\t\tdata.includeExtended = input.includeExtended;\n\t} else {\n\t\tif (!data.ticketTitle) {\n\t\t\tif (gr.short_description.canRead())\n\t\t\t\tdata.ticketTitle = gr.getDisplayValue(\"short_description\");\n\t\t\tif (!data.ticketTitle)\n\t\t\t\tdata.ticketTitle = data.number;\n\t\t}\n\n\t\t$sp.logStat('Task View', data.table, data.sys_id);\n\t}\n\n\tdata.canWrite = gr.canWrite();\n\tdata.canAttach = userCanAttach(gr);\n\tdata.canRead = gr.canRead();\n\tdata.hasWritableJournalField = false;\n\tdata.hasReadableJournalField = false;\n\tif (data.canRead && !data.isNewRecord) {\n\t\tdata.stream = $sp.getStream(data.table, data.sys_id);\n\t\t// Journal fields come in correct order already\n\t\t// so grab the first 2 writeable fields\n\t\tif ('journal_fields' in data.stream) {\n\t\t\tvar jf = data.stream.journal_fields;\n\t\t\tfor(var i=0; i < jf.length; i++){\n\t\t\t\tif (jf[i].can_read === true)\n\t\t\t\t\tdata.hasReadableJournalField = true;\n\t\t\t\tif (jf[i].can_write === true){\n\t\t\t\t\tdata.hasWritableJournalField = true;\n\t\t\t\t\tif (!data.primaryJournalField)\n\t\t\t\t\t\tdata.primaryJournalField = jf[i];\n\t\t\t\t\telse if (data.includeExtended && !data.secondaryJournalField)\n\t\t\t\t\t\tdata.secondaryJournalField = jf[i];\n\t\t\t\t\telse\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t}\n\n\tdata.tableLabel = gr.getLabel();\n\n\tfunction userCanAttach(originalRecord) {\n\t\tif (!gs.hasRole(gs.getProperty(\"glide.attachment.role\")))\n\t\t\treturn false;\n\t\t\n\t\t// To check whether user can upload attachments, need to check \"no_attachment\" table\n\t\t// attribute of the target record (e.g., incident vs. task), so fetch it if we need to.\n\t\t// GlideRecordScriptUtil.getRealRecord is not available to scoped apps, so can't use it.\n\t\tvar targetRecordForAttributes = originalRecord;\n\t\tif (originalRecord.getRecordClassName() != originalRecord.getTableName()) {\n\t\t\ttargetRecordForAttributes = new GlideRecord(originalRecord.getRecordClassName());\n\t\t\ttargetRecordForAttributes.get(originalRecord.getUniqueValue());\n\t\t}\n\t\treturn targetRecordForAttributes.getAttribute(\"no_attachment\") != \"true\";\n\t}\n\n})()]]></script><servicenow>true</servicenow><sys_class_name>sp_widget</sys_class_name><sys_created_by>admin</sys_created_by><sys_created_on>2015-06-24 17:56:48</sys_created_on><sys_id>85357f52cb30020000f8d856634c9c24</sys_id><sys_mod_count>863</sys_mod_count><sys_name>Ticket Conversations</sys_name><sys_package display_value=\"Service Portal - Core\" source=\"com.glide.service-portal\">7ea7d07fdb161010c6ea1fc7689619a1</sys_package><sys_policy/><sys_scope display_value=\"Global\">global</sys_scope><sys_update_name>sp_widget_85357f52cb30020000f8d856634c9c24</sys_update_name><sys_updated_by>admin</sys_updated_by><sys_updated_on>2020-06-11 10:40:20</sys_updated_on><template><![CDATA[<div>\n<div ng-if=\"!data.canRead && !data.isNewRecord\">\n    ${Requested record not found}\n  </div>\n<div ng-if=\"data.canRead && !data.isNewRecord\" class=\"panel panel-{{options.color}} b ticket_conversation\">\n<div class=\"panel-heading\">\n\n<div class=\"h2 panel-title panel-title-container\">\n<h2 class=\"h4 panel-title\" aria-label=\"{{::data.ticketTitle}} ${Ticket history}\">{{::data.ticketTitle}}</h2>\n\n<div class=\"pull-right panel-title-icons\">\n<ul>\n<li>\n<button href ng-show=\"data.showLocationIcon && data.canWrite\" class=\"panel-button btn btn-link\" ng-click=\"checkInLocation()\" title=\"{{data.checkInLocMsg}}\">\n<span class=\"glyphicon glyphicon-globe\"></span>\n</button>\n</li>\n<li>\n<button href class=\"panel-button btn btn-link\" ng-show=\"isNative\" ng-click=\"scanBarcode()\" title=\"{{data.scanBarcodeMsg}}\">\n<span class=\"glyphicon glyphicon-barcode\"></span>\n</button>\n</li>\n<li ng-if=\"::(!data.hideAttachmentBtn)\"><sp-attachment-button ng-if=\"::data.canWrite && data.canAttach\"></sp-attachment-button></li>\n</ul>\n</div>\n</div>\n\n</div>\n\n<div class=\"panel-body\">\n<div ng-if=\"data.hasReadableJournalField\">\n<form ng-submit=\"postEntry(data.journalEntry)\" id=\"sand\">\n<div ng-show=\"data.hasWritableJournalField\" class=\"input-group\">\n<textarea ng-keypress=\"keyPress($event)\" sn-resize-height=\"trim\" rows=\"1\" id=\"post-input\" class=\"form-control no-resize overflow-hidden\" ng-model='data.journalEntry' ng-model-options='{debounce: 250}' ng-attr-placeholder=\"{{getPlaceholder()}}\" aria-label=\"{{getPlaceholder()}}\" autocomplete=\"off\" ng-change=\"userTyping(data.journalEntry)\"/>\n<span class=\"journal-field-indicator\" ng-style=\"({'background-color': data.useSecondaryJournalField ? data.secondaryJournalField.color : data.primaryJournalField.color})\"></span>\n<span class=\"input-group-btn\" style=\"vertical-align: top\">\n<input type=\"submit\" class=\"btn btn-primary\" value=\"{{data.btnLabel}}\" ng-disabled=\"data.isPosting\"/>\n</span>\n</div>\n<div ng-if=\"::(data.secondaryJournalField && data.secondaryJournalField.can_write)\">\n<label class=\"pull-right\">\n<input type=\"checkbox\" ng-model=\"::data.useSecondaryJournalField\" ng-change=\"updateFormWithJournalFields()\"/>\n<span> {{::data.secondaryJournalField.label}}</span>\n</label>\n</div>\n</form>\n<ul class=\"list-group m-b-none\" ng-if=\"typing.length > 0\">\n<li class=\"list-group-item user-typing m-t\" ng-repeat=\"u in typing\">${{{::u.user_display_name}} is typing}</li>\n</ul>\n<ul class=\"list-group m-b-none m-t\" ng-if=\"msg\">\n<li class=\"list-group-item user-typing\">{{msg}}</li>\n</ul>\n<div class=\"timeline-container\">\n<ul role=\"list\" class=\"timeline\" aria-label=\"${Ticket history}\">\n<div class=\"timeline-before\" role=\"presentation\" aria-hidden=\"true\" />\n<li class=\"timeline-item\" ng-class=\"::{'timeline-inverted': e.user_sys_id == data.currentUserID}\" ng-repeat=\"e in data.mergedEntries\">\n<div class=\"timeline-badge\">\n<sn-avatar-once ng-if=\"hasLiveProfile(e.user_sys_id)\" primary=\"getLiveProfileByUserId(e.user_sys_id)\" class=\"avatar-large\" show-presence=\"false\" enable-context-menu=\"false\">\n</sn-avatar-once>\n</div>\n<div class=\"timeline-panel\">\n<div class=\"timeline-panel-inner\" ng-style=\"::{'border-color': getFieldColor(e.element)}\">\n<div class=\"timeline-heading\">\n<div class=\"timeline-title h4\">{{::e.name}}</div>\n<p class = \"time-text\">\n<small class=\"text-muted\">\n<span class=\"glyphicon glyphicon-time\" aria-hidden=\"true\" tabindex=\"-1\" />\n<sn-time-ago timestamp=\"::e.sys_created_on\" />\n</small>\n<i ng-if=\"::e.field_label\" class=\"fa fa-circle text-muted\" aria-hidden=\"true\"></i>\n<small class = \"text-muted journal-type\">{{::e.field_label}}</small>\n<span ng-if= \"::((e.element == 'comments' || e.element == 'work_notes') && data.isTranslationEnabled)\">\n<small class=\"text-muted translation-delimiter\">•</small>\n<span class=\"translate-wrap\">\n<i class=\"text-muted translation-icon icon-translation\"></i>\n<a class=\"translate-link\" role=\"button\" href=\"javascript:void(0)\" ng-click=\"translateText(e, false)\">{{::data.translation.translateLinkMsg}}</a>\n</span>\n</span>\n</p>\n</div>\n<div class=\"timeline-body\">\n<p ng-if=\"::(e.element != 'attachment')\" ng-bind-html=\"::trustAsHtml(e.value)\"></p>\n<div ng-if=\"::(e.element == 'attachment')\">\n<a ng-if=\"(e.attachment.state == 'available' && e.attachment.thumbnail_path)\" target=\"_blank\" href=\"/sys_attachment.do?view=true&sys_id={{::e.attachment.sys_id}}\" aria-label=\"{{e.attachment.viewImage ? data.viewAttachmentMsg : data.downloadAttachmentMsg}} {{::e.attachment.file_name}}\">\n<img alt=\"\" ng-src=\"/{{::e.attachment.path}}?t=medium\" class=\"img-responsive\"/>\n</a>\n<a ng-if=\"((e.attachment.state == '' || e.attachment.state == 'pending' || e.attachment.state == 'available_conditionally') && e.attachment.thumbnail_path)\" ng-click=\"scanAttachment(e.attachment)\" href=\"javascript:void(0)\" aria-label=\"{{e.attachment.viewImage ? data.viewAttachmentMsg : data.downloadAttachmentMsg}} {{::e.attachment.file_name}}\">\n<img alt=\"\" ng-src=\"/{{::e.attachment.path}}?t=medium\" class=\"img-responsive\"/>\n</a>\n<div>\n<div ng-if=\"(e.attachment.state == 'available')\">\n<a href=\"/sys_attachment.do?sys_id={{::e.attachment.sys_id}}\" target=\"_blank\" title=\"{{dataViewMsg}}\"><strong>{{e.attachment.file_name}}</strong></a><br/>\n                        {{::e.attachment.size}}\n                      </div>\n<div ng-if=\"(e.attachment.state == 'not_available')\">\n<span title=\"{{dataViewMsg}}\" class=\"not_available\">{{e.attachment.file_name}}</span><br/>\n<span class=\"error\">{{::data.scanFailedMsg}}</span>\n</div>\n<div ng-if=\"(e.attachment.state == '' || e.attachment.state == 'pending' || e.attachment.state == 'available_conditionally')\">\n<a href=\"javascript:void(0)\" ng-click=\"scanAttachment(e.attachment)\" title=\"{{dataViewMsg}}\"><strong>{{e.attachment.file_name}}</strong></a><br/>\n                        {{::e.attachment.size}}\n                      </div>\n</div>\n</div>\n</div>\n<div ng-if=\"e.showTranslation\" class=\"translation-container\">\n<div ng-if=\"e.isTranslationInProgress\">\n<i class=\"translation-icon icon-translation\"></i>\n<span aria-live=\"polite\">{{::data.translation.translationProgressMsg}}</span>\n</div>\n<div ng-if=\"e.isTranslationSuccess\">\n<i class=\"translation-icon icon-translation\"></i>\n<a class=\"translate-link\" role=\"button\" href=\"javascript:void(0)\" ng-click=\"toggleTranslation(e)\">{{e.toggleMsg}}</a>\n<span class=\"translation-delimiter\">•</span>\n<span class=\"translation-credits\">{{e.credits}}</span>\n<div ng-if=\"e.showDetails\" class=\"translation-message\" ng-bind-html=\"::e.translatedText\">\n</div>\n</div>\n<div ng-if=\"e.isTranslationError\">\n<i class=\"translation-icon icon-translation\"></i>\n{{e.translatedText}}\n<a ng-if=\"e.tryAgain\" role=\"button\" href=\"javascript:void(0)\" class=\"translate-link\" ng-click=\"translateText(e, true)\">{{::data.translation.tryAgainMsg}}</a>\n</div>\n</div>\n</div>\n</div>\n</li>\n<li role=\"listitem\" class=\"timeline-item\" ng-class=\"::{'timeline-inverted': data.stream.user_sys_id == data.currentUserID}\" aria-label=\"{{data.stream.user_full_name}}\">\n<div class=\"timeline-badge\">\n<sn-avatar-once ng-if=\"hasLiveProfile(data.stream.user_sys_id)\" primary=\"getLiveProfileByUserId(data.stream.user_sys_id)\" class=\"avatar-large\" show-presence=\"false\" enable-context-menu=\"false\">\n</sn-avatar-once>\n</div>\n<div class=\"timeline-panel timeline-panel-first-item\">\n<div class=\"timeline-heading\">\n<div class=\"timeline-title h4\">{{data.stream.user_full_name}}</div>\n<p>\n<small class=\"text-muted\">\n<span class=\"glyphicon glyphicon-time\" aria-hidden=\"true\" tabindex=\"-1\" />\n<sn-time-ago timestamp=\"data.created_on\" />\n</small>\n</p>\n</div>\n<div class=\"timeline-body\">\n<p>{{data.number}} ${Created}</p>\n</div>\n</div>\n</li>\n<li>\n<div class=\"timeline-badge-wrap\">\n<div class=\"timeline-badge success\">\n<span>${Start}</span>\n</div>\n</div>\n</li>\n</ul>\n</div>\n\n</div>\n<div ng-if=\"!data.hasReadableJournalField\">\n        {{options.no_readable_journal_field_message}}\n      </div>\n</div>\n</div>\n</div>]]></template></sp_widget>",
  "sys_class_name": "sp_rel_widget_clone",
  "sys_created_by": "admin",
  "sys_created_on": "2020-10-05 18:17:08",
  "sys_id": "cae60befdba31010c6ea1fc768961971",
  "sys_mod_count": 0,
  "sys_name": "cee68fafdba31010c6ea1fc768961951",
  "sys_package": "e515ade9db131010c6ea1fc7689619ad",
  "sys_policy": null,
  "sys_scope": "e515ade9db131010c6ea1fc7689619ad",
  "sys_update_name": "sp_rel_widget_clone_cae60befdba31010c6ea1fc768961971",
  "sys_updated_by": "admin",
  "sys_updated_on": "2020-10-05 18:17:08"
}
